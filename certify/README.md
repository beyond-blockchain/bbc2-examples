Certify
==========
This app provides a very simple Web service sample to provide functionality of registering and verifying certificates.

The sample Web application lets a user register single documents, as well as register multiple documents at once, and build a certificate out of the original document and its Merkle proof, which the user can download.


## Dependencies
* bbc2 >= 0.1


## Installing dependencies
You need to pip-install bbc2. It is currently at its early development stage, and you will need to do `git clone -b develop [URI]`  to clone the project's development branch, go to the project directory and `python setup.py sdist` to generate an installer tar ball, and then `pip install dist/[tar.gz file]`.

* For further information on installing and using bbc2, please wait.


## Documents and Certificates
A document or a certificate (which is a document with Merkle proof information) in this examlpe is a JSON text, but translated into XML at the server side because that is the format used in bbc2 document library (see Flask execution log for the effect). An example of a document follows.
```
{
  "id": "AR-1838B",
  "title": "I Am the Walrus",
  "artist": "The Beatles",
  "writer": "Lennon-McCartney",
  "year": "1967"
}
```
To get the cryptographic digest of a document (for proof), this example takes each key-value pair as an XML element (```<id/>```, ```<title/>```, ```<artist/>```, ```<writer/>```,```<year/>``` for the above), calculate their SHA-256 digests, concatinate them all, and then calculate its SHA-256 digest. If a value is a dictionary, this algorithm is applied recursively.

You can specify multiple documents at once with the app for registration by specifying them with an array with key "_docs". Please see "beatles-singles-doc.json" sample document file accompanied with this example.

There are keys that give special meanings to their value:
* **id** Number or string that identifies the document.
* **digest** (in fact any key starting with 'digest', to make keys unique) SHA-256 digest of a hidden element (functionality of bbc2 document library). Upon calculating the cryprographic digest of the document or certificate, the value is considered as the hexadecimal representation of the digest of the key-value pair at the position. You can use the provided app to obtain the SHA-256 digest of any JSON (sub-)document.
* **proof** (reserved for this purpose and generated by proof API) Merkle proof information for the document. Please see "i-am-the-walrus-cert.json" sample certificate.
* **privkey** Private key (used only when signing the document with it).
* **pubkey** Public key to verify a signature.
* **sig** Digital signature. Needs to be accompanied by **pubkey**. If this key is present, the cryptographic digest of the document (or part of the document, depending on where this key appears) is considered signed, the signature is verified, and the new digest is calculated over concatination of the digest, the public key, the 2-byte key-type code (see bbclib.KeyType) and the signature. Please see "ishindenshin-cert.json" sample certificate.
* **algo** Digital signature algorithm in use. Currently supports ECDSA_SECP256k1 (ecdsa-secp256k1) and ECDSA_P256v1 (ecdsa-p256v1). ECDSA p256v1 is the default.
* **salt** If this key is present and the value is a dictionary, the key-value pairs in the dictionary are considered to specify salts for the keys to calculate digests, if those keys are found at the same level as this key.

## How to use this example
Below, it is assumed that "bbc_serv.py" runs at the user's home directory, and Ethereum's goerli testnet is used (and you have a sufficient amount of ETH (0.1 would be more than enough) in an account in goerli). At first, "bbc_serv.py" should be stopped.

1. Set up ledger subsystem (this writes to BBc-2 config file)
    ```
    bbc_eth_tool.py -w ~/.bbc2 auto [infura.io project ID] [private key]
    ```
    Take note (make copy) of the displayed contract address that was deployed by the command above.

2. Start bbc_serv.py

3. Set up the application domain for BBc-2

    POST 'api/setup' to set up.
    ```shell
    $ curl -X POST http://IP_ADDRESS:PORT/cert/setup
    {"domain_id": DOMAIN_ID} # returned
    ```

4. Stop bbc_serv.py (because again we will write to BBc-2 config file)

5. Configure Merkle tree settings of the ledger subsystem

    ```
    bbc_eth_tool.py -w ~/.bbc2 -d [domain id] config_tree [number of certificates] [seconds]
    ```
        
    This configures the subsystem so that Merkle tree is closed and Merkle root is written to a Ethereum blockchain (goerli by default) upon reaching either the specified number of processed documents or the specified seconds.

6. Start bbc_serv.py

7. Start index.py of this example

    By default, the server runs at "http://localhost:5000/cert". You can paste your JSON document onto the text area, or open an existing JSON file for processing.
